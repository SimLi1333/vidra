"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[8e3],{2739:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"topics/testing","title":"Testing","description":"This document outlines the approaches, methodologies, and types of tests that ensure that the Vidra Operator components are functioning as expected.","source":"@site/docs/topics/testing.md","sourceDirName":"topics","slug":"/topics/testing","permalink":"/vidra/topics/testing","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Testing","sidebar_position":6},"sidebar":"cliSidebar","previous":{"title":"Cluster Setup","permalink":"/vidra/topics/deploy"},"next":{"title":"Continuos Integration","permalink":"/vidra/topics/ci"}}');var s=n(4848),r=n(8453),o=n(7293);const a={title:"Testing",sidebar_position:6},c="Vidra Operator Testing Strategy",l={},d=[{value:"Test Categories",id:"test-categories",level:2},{value:"Tools",id:"tools",level:2},{value:"Strategies: Test Approach",id:"strategies-test-approach",level:2},{value:"Unit Tests",id:"unit-tests",level:3},{value:"End to end Tests",id:"end-to-end-tests",level:3},{value:"Test Coverage Goals",id:"test-coverage-goals",level:2}];function h(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"vidra-operator-testing-strategy",children:"Vidra Operator Testing Strategy"})}),"\n",(0,s.jsxs)(t.p,{children:["This document outlines the approaches, methodologies, and types of tests that ensure that the ",(0,s.jsx)(t.strong,{children:"Vidra Operator"})," components are functioning as expected."]}),"\n",(0,s.jsx)(t.p,{children:"The primary goal of testing is to maintain a high level of code reliability and confidence when integrating changes. We aim to build a robust test suite that supports both fast local iteration and CI-based validation."}),"\n",(0,s.jsx)(t.h2,{id:"test-categories",children:"Test Categories"}),"\n",(0,s.jsx)(t.p,{children:"The current focus of our testing strategy is on:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Functionality"}),": Ensuring that the Vidra Operator behaves correctly under different conditions."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Logic"}),": Verifying that business logic and reconciliation workflows operate as expected."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Future test categories may include:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.strong,{children:"Security Testing"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.strong,{children:"Performance and Load Testing"})}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"tools",children:"Tools"}),"\n",(0,s.jsx)(t.p,{children:"We use the following tools and frameworks to test the Vidra Operator:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsxs)(t.strong,{children:["Go ",(0,s.jsx)(t.code,{children:"testing"})," package"]}),": The standard Go testing library used as a foundation for automated test cases."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Ginkgo"}),": A BDD-style Go testing framework that enables expressive and structured test suites."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Gomega"}),": A matcher/assertion library used with Ginkgo to write clear and readable expectations in tests."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"EnvTest"}),": A part of the ",(0,s.jsx)(t.code,{children:"controller-runtime"})," library that spins up a local Kubernetes API server and etcd for testing purposes. This is particularly useful for integration and controller-level tests."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Kubernetes Client Libraries"}),": Used to interact with the Kubernetes API, allowing tests to create, update, and delete resources as needed."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Mockgen"}),": A tool for generating mock implementations of real interface implementations, which can be used to isolate components during testing."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Fake Clients"}),": Used to simulate a second Kubernetes API for testing purposes, allowing us to test interactions without requiring a second envtest cluster just for the multicluster feature and still have more realistic API interactions for the normal controller interaction."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"strategies-test-approach",children:"Strategies: Test Approach"}),"\n",(0,s.jsx)(t.p,{children:"Our testing approach is divided into two primary types:"}),"\n",(0,s.jsx)(t.h3,{id:"unit-tests",children:"Unit Tests"}),"\n",(0,s.jsxs)(t.p,{children:["Unit tests of single functions are mainly written for adapter packages. For the controller logic, it makes more sense to use integration tests, as the controller logic is tightly coupled with the Kubernetes API and CRDs.\nThats why you will see most Vidra operator tests are implemented using the ",(0,s.jsx)(t.code,{children:"envtest"})," environment from ",(0,s.jsx)(t.code,{children:"controller-runtime"}),". While ",(0,s.jsx)(t.code,{children:"envtest"})," is typically used for integration testing the whole software at once, we leverage it even for isolated logic tests to provide realistic API interactions without requiring mocking or fake clients."]}),"\n",(0,s.jsx)(t.p,{children:"This approach allows us to:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Test reconciliation logic and Kubernetes resource interactions against a real API server and etcd."}),"\n",(0,s.jsx)(t.li,{children:"Avoid discrepancies between fake clients and real controller behavior."}),"\n",(0,s.jsx)(t.li,{children:"Maintain higher confidence in test accuracy, especially when working with CRDs and status updates."}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["Tests remain lightweight and fast due to ",(0,s.jsx)(t.code,{children:"envtest"}),"\u2019s in-memory setup, making them practical for local development and CI validation."]}),"\n",(0,s.jsx)(t.p,{children:"We did create a fake moked client to simulate failures of the Kubernetes API server, which allows us to test how the controller handles errors and retries. As there is currently no other way to simulate API server failures in a realistic way."}),"\n",(0,s.jsxs)(t.p,{children:["All ",(0,s.jsx)(t.code,{children:"VidraResource"})," reconciliation tests are executed twice: once applying the resources to the local cluster and once to a simulated second cluster. This ensures that the reconciliation logic works correctly in both single-cluster and multi-cluster scenarios."]}),"\n",(0,s.jsxs)(t.p,{children:["The k8s adapter packages are again tested using ",(0,s.jsx)(t.code,{children:"envtest"}),", but with a focus on isolated logic rather than full controller behavior. This allows us to verify that the adapter functions correctly interact with the Kubernetes API, such as creating a second client for interacting with a different cluster."]}),"\n",(0,s.jsxs)(t.p,{children:["The event-based feature is tested by moking the callback functions that are called when a resource is created or updated. This allows us to verify that the controller correctly handles events and updates the ",(0,s.jsx)(t.code,{children:"VidraResource"})," status accordingly."]}),"\n",(0,s.jsx)(t.h3,{id:"end-to-end-tests",children:"End to end Tests"}),"\n",(0,s.jsx)(t.p,{children:"E2e tests verify that multiple components of the operator work correctly when interacting with a real (but local and temporary) Kubernetes API server. These tests use the real image built and uploaded to the github registry, ensuring that the operator behaves as expected in a realistic environment."}),"\n",(0,s.jsxs)(t.p,{children:["It deploys the operator to a real Kubernetes cluster and monitors its behavior and metrics using ",(0,s.jsx)(t.code,{children:"prometheus"})," and Webhooks. It uses ",(0,s.jsx)(t.code,{children:"cert-manager"})," for creating TLS certificates for webhooks (such as admission or conversion webhooks)."]}),"\n",(0,s.jsx)(t.p,{children:"The tests ensure the operators:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Installation"}),": Verifying that the operator can be installed and configured correctly from the online repository."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"RBAC"}),": Ensuring that the operator has the necessary permissions to create and manage resources."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"test-coverage-goals",children:"Test Coverage Goals"}),"\n",(0,s.jsxs)(t.p,{children:["We aim to maintain at least ",(0,s.jsx)(t.strong,{children:"80% test coverage"})," for the Vidra Operator. Achieving this level of coverage helps ensure:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Stability over time"}),"\n",(0,s.jsx)(t.li,{children:"Safe refactoring and maintenance"}),"\n",(0,s.jsx)(t.li,{children:"Quick feedback cycles in development"}),"\n",(0,s.jsx)(t.li,{children:"No need to test every error catch block, but rather focus on critical paths and business logic"}),"\n",(0,s.jsxs)(t.li,{children:["Rather than chacing 100% coverage, we prioritize testing business logic like runing all ",(0,s.jsx)(t.code,{children:"VidraResource"})," reconciliation tests again for the multicluster feature, ensuring that the core functionality remains intact."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Coverage reports are generated and published in CI for visibility and enforcement using codecov."}),"\n",(0,s.jsxs)(o.A,{type:"note",title:"Local Coverage Check",children:[(0,s.jsx)(t.p,{children:"A local visual coverage can be checked using:"}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"make test\ngo tool cover -html=cover.out\n"})})]}),"\n",(0,s.jsx)(t.hr,{})]})}function u(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},7293:(e,t,n)=>{n.d(t,{A:()=>M});var i=n(6540),s=n(4848);function r(e){const{mdxAdmonitionTitle:t,rest:n}=function(e){const t=i.Children.toArray(e),n=t.find((e=>i.isValidElement(e)&&"mdxAdmonitionTitle"===e.type)),r=t.filter((e=>e!==n)),o=n?.props.children;return{mdxAdmonitionTitle:o,rest:r.length>0?(0,s.jsx)(s.Fragment,{children:r}):null}}(e.children),r=e.title??t;return{...e,...r&&{title:r},children:n}}var o=n(4164),a=n(1312),c=n(7559);const l="admonition_xJq3",d="admonitionHeading_Gvgb",h="admonitionIcon_Rf37",u="admonitionContent_BuS1";function p({type:e,className:t,children:n}){return(0,s.jsx)("div",{className:(0,o.A)(c.G.common.admonition,c.G.common.admonitionType(e),l,t),children:n})}function g({icon:e,title:t}){return(0,s.jsxs)("div",{className:d,children:[(0,s.jsx)("span",{className:h,children:e}),t]})}function m({children:e}){return e?(0,s.jsx)("div",{className:u,children:e}):null}function x(e){const{type:t,icon:n,title:i,children:r,className:o}=e;return(0,s.jsxs)(p,{type:t,className:o,children:[i||n?(0,s.jsx)(g,{title:i,icon:n}):null,(0,s.jsx)(m,{children:r})]})}function f(e){return(0,s.jsx)("svg",{viewBox:"0 0 14 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})})}const j={icon:(0,s.jsx)(f,{}),title:(0,s.jsx)(a.A,{id:"theme.admonition.note",description:"The default label used for the Note admonition (:::note)",children:"note"})};function v(e){return(0,s.jsx)(x,{...j,...e,className:(0,o.A)("alert alert--secondary",e.className),children:e.children})}function y(e){return(0,s.jsx)("svg",{viewBox:"0 0 12 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"})})}const b={icon:(0,s.jsx)(y,{}),title:(0,s.jsx)(a.A,{id:"theme.admonition.tip",description:"The default label used for the Tip admonition (:::tip)",children:"tip"})};function w(e){return(0,s.jsx)(x,{...b,...e,className:(0,o.A)("alert alert--success",e.className),children:e.children})}function T(e){return(0,s.jsx)("svg",{viewBox:"0 0 14 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})})}const A={icon:(0,s.jsx)(T,{}),title:(0,s.jsx)(a.A,{id:"theme.admonition.info",description:"The default label used for the Info admonition (:::info)",children:"info"})};function k(e){return(0,s.jsx)(x,{...A,...e,className:(0,o.A)("alert alert--info",e.className),children:e.children})}function C(e){return(0,s.jsx)("svg",{viewBox:"0 0 16 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"})})}const N={icon:(0,s.jsx)(C,{}),title:(0,s.jsx)(a.A,{id:"theme.admonition.warning",description:"The default label used for the Warning admonition (:::warning)",children:"warning"})};function I(e){return(0,s.jsx)("svg",{viewBox:"0 0 12 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})})}const V={icon:(0,s.jsx)(I,{}),title:(0,s.jsx)(a.A,{id:"theme.admonition.danger",description:"The default label used for the Danger admonition (:::danger)",children:"danger"})};const z={icon:(0,s.jsx)(C,{}),title:(0,s.jsx)(a.A,{id:"theme.admonition.caution",description:"The default label used for the Caution admonition (:::caution)",children:"caution"})};const R={...{note:v,tip:w,info:k,warning:function(e){return(0,s.jsx)(x,{...N,...e,className:(0,o.A)("alert alert--warning",e.className),children:e.children})},danger:function(e){return(0,s.jsx)(x,{...V,...e,className:(0,o.A)("alert alert--danger",e.className),children:e.children})}},...{secondary:e=>(0,s.jsx)(v,{title:"secondary",...e}),important:e=>(0,s.jsx)(k,{title:"important",...e}),success:e=>(0,s.jsx)(w,{title:"success",...e}),caution:function(e){return(0,s.jsx)(x,{...z,...e,className:(0,o.A)("alert alert--warning",e.className),children:e.children})}}};function M(e){const t=r(e),n=(i=t.type,R[i]||(console.warn(`No admonition component found for admonition type "${i}". Using Info as fallback.`),R.info));var i;return(0,s.jsx)(n,{...t})}},8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var i=n(6540);const s={},r=i.createContext(s);function o(e){const t=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);